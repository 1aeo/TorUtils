<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mimalloc 3.0.1 Regression: Why Older is Better for Tor Relays | 1st Amendment Encrypted Openness</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; text-align: center; background-color: #121212; color: #ffffff; }
    .nav { background-color: #1e1e1e; padding: 10px 0; box-shadow: 0 2px 10px rgba(0, 255, 127, 0.2); position: sticky; top: 0; z-index: 1000; }
    .nav-toggle { display: none; background: none; border: none; font-size: 24px; color: #00ff7f; position: absolute; top: 10px; right: 20px; cursor: pointer; }
    .nav-links { display: flex; justify-content: center; flex-wrap: wrap; }
    .nav-links a { color: #00ff7f; text-decoration: none; margin: 0 15px; font-size: 18px; }
    .nav-links a:hover { text-decoration: underline; }
    @media (max-width: 600px) { .nav-links { display: none; flex-direction: column; margin-top: 40px; } .nav-links.show { display: flex; } .nav-toggle { display: block; } }
    .container { max-width: 800px; margin: 50px auto; padding: 20px; background: #1e1e1e; box-shadow: 0px 0px 15px rgba(0, 255, 127, 0.6); border-radius: 10px; text-align: left; }
    h1, h2, h3 { color: #00ff7f; }
    h1 { text-align: center; }
    p { font-size: 18px; color: #cccccc; line-height: 1.6; margin-bottom: 1em; }
    .meta { font-size: 14px; color: #888; margin-bottom: 20px; text-align: center; }
    ul, ol { color: #cccccc; margin-bottom: 1em; }
    li { font-size: 18px; margin-bottom: 8px; line-height: 1.6; }
    code { background-color: #2d2d2d; padding: 2px 6px; border-radius: 3px; font-family: monospace; color: #00ff7f; }
    pre { background-color: #2d2d2d; padding: 15px; border-radius: 5px; overflow-x: auto; }
    pre code { background: none; padding: 0; color: #ffffff; }
    a { color: #00ff7f; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container img { display: block; margin: 20px auto; max-width: 100%; height: auto; border-radius: 5px; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #444; }
    th { background-color: #2d2d2d; color: #00ff7f; }
    td { color: #cccccc; }
    tr:hover { background-color: #252525; }
    .warning { background-color: #2d2d2d; border-left: 4px solid #ff6b6b; padding: 15px; margin: 20px 0; border-radius: 0 5px 5px 0; }
    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #333; font-size: 14px; color: #777; text-align: center; }
    .btn { display: inline-block; margin-top: 20px; padding: 12px 24px; font-size: 18px; color: #121212; background-color: #00ff7f; text-decoration: none; font-weight: bold; border-radius: 5px; transition: background 0.3s; }
    .btn:hover { background-color: #00cc66; text-decoration: none; }
    .highlight { color: #ff6b6b; font-weight: bold; }
    .success { color: #00ff7f; font-weight: bold; }
  </style>
</head>
<body>
  <div class="nav">
    <button class="nav-toggle" onclick="document.querySelector('.nav-links').classList.toggle('show')">&#9776;</button>
    <div class="nav-links">
      <a href="/">Home</a>
      <a href="/blog">Blog</a>
      <a href="https://metrics.1aeo.com">Metrics</a>
      <a href="https://aroivalidator.1aeo.com">AROI Validator</a>
      <a href="https://routefluxmap.1aeo.com">RouteFluxMap</a>
      <a href="/#contact">Contact</a>
    </div>
  </div>

  <div class="container">
    <h1>mimalloc 3.0.1 Regression: Why Older is Better for Tor Relays</h1>
    <p class="meta"><em>By 1AEO Team ‚Ä¢ January 2026</em></p>

    <p class="meta"><em>Experiment: 200 relays (5 allocator groups) over 9 days on Debian 13 with Tor 0.4.8.x</em></p>

    <p>After discovering that mimalloc dramatically outperforms glibc for Tor relays, we assumed the latest version would be best. <strong>We were wrong.</strong> Our 200-relay experiment on <strong>Debian 13</strong> reveals that <span class="highlight">mimalloc 3.0.1 has a severe regression</span>‚Äîusing nearly 7x more memory than mimalloc 2.0.9.</p>

    <h2>The Results</h2>
    <p>The version differences were dramatic. While mimalloc 2.0.9 stayed rock-solid at ~1.3 GB, version 3.0.1 ballooned to nearly 9 GB:</p>

    <table>
      <thead>
        <tr><th>Allocator</th><th>Avg Memory</th><th>vs glibc</th><th>vs 3.0.1</th><th>Status</th></tr>
      </thead>
      <tbody>
        <tr><td><strong class="success">mimalloc 2.0.9</strong></td><td><strong>1.28 GB</strong></td><td>68% less</td><td>6.7x less</td><td>‚úÖ Stable</td></tr>
        <tr><td><strong>mimalloc 2.1.7</strong></td><td>1.72 GB</td><td>57% less</td><td>5.0x less</td><td>‚úÖ Stable</td></tr>
        <tr><td>jemalloc 5.3.0</td><td>2.64 GB</td><td>34% less</td><td>3.3x less</td><td>‚úÖ Stable</td></tr>
        <tr><td>glibc 2.41</td><td>4.01 GB</td><td>‚Äî</td><td>2.1x less</td><td>üìà Growing</td></tr>
        <tr><td><span class="highlight">mimalloc 3.0.1</span></td><td><span class="highlight">8.62 GB</span></td><td>115% more</td><td>‚Äî</td><td>‚ùå Bloating</td></tr>
      </tbody>
    </table>

    <img src="images/mimalloc-version-regression-3x-vs-2x-tor-relays-chart.png" alt="mimalloc Version Comparison Chart">

    <h2>The Regression Pattern</h2>
    <p>mimalloc 3.0.1 showed clear pathological behavior:</p>
    <ul>
      <li><strong>Day 1:</strong> Started at ~1.9 GB (normal)</li>
      <li><strong>Day 3:</strong> Already at 3.3 GB (warning sign)</li>
      <li><strong>Day 5:</strong> Reached 5.3 GB (matching glibc)</li>
      <li><strong>Day 9:</strong> Hit 8.6 GB and still climbing (~1 GB/day)</li>
    </ul>
    <p>Meanwhile, mimalloc 2.0.9 flatlined at 1.28 GB from Day 3 onward. This isn't gradual growth‚Äîit's a regression in how 3.x handles memory-intensive workloads like Tor's directory cache.</p>

    <h2>Why 2.x Wins</h2>
    <p>The mimalloc 2.x series appears to return memory to the OS more aggressively. Changes in the 3.x architecture‚Äîlikely related to segment management or arena strategies‚Äîseem to cause memory retention that's problematic for Tor's allocation patterns.</p>
    <p>This isn't a Tor-specific bug; it's a mismatch between mimalloc 3.x's optimization targets (short-lived allocations, high throughput) and Tor's needs (long-running, many small allocations, memory efficiency).</p>

    <div class="warning">
      <strong>‚ö†Ô∏è Warning:</strong> The Debian 13 package (<code>libmimalloc2.0</code>) ships mimalloc 3.0.1‚Äî<strong>don't use it</strong> for Tor relays. Build version 2.0.9 from source instead.
    </div>

    <h2>How to Deploy (Debian 13)</h2>
    <p>Build mimalloc 2.0.9 from source:</p>

    <pre><code># Build mimalloc 2.0.9
wget https://github.com/microsoft/mimalloc/archive/refs/tags/v2.0.9.tar.gz
tar xzf v2.0.9.tar.gz && cd mimalloc-2.0.9
mkdir build && cd build && cmake .. && make
sudo cp libmimalloc.so.2.0 /usr/local/lib/mimalloc/libmimalloc-2.0.9.so</code></pre>

    <p>Create the systemd override:</p>

    <pre><code># Enable per-relay
sudo mkdir -p /etc/systemd/system/tor@relay_name.service.d
sudo tee /etc/systemd/system/tor@relay_name.service.d/allocator.conf &lt;&lt;EOF
[Service]
Environment="LD_PRELOAD=/usr/local/lib/mimalloc/libmimalloc-2.0.9.so"
EOF
sudo systemctl daemon-reload && sudo systemctl restart tor@relay_name</code></pre>

    <h2>Bottom Line</h2>
    <p>Version numbers don't always mean better. For Tor relays on Debian 13:</p>
    <ol>
      <li><strong class="success">Use mimalloc 2.0.9</strong> ‚Äî Best results, most stable (1.28 GB)</li>
      <li><strong class="highlight">Avoid mimalloc 3.0.1</strong> ‚Äî Severe regression, grows unbounded</li>
      <li><strong>jemalloc 5.3.0</strong> ‚Äî Good fallback available via <code>apt install libjemalloc2</code></li>
    </ol>
    <p>We're reporting this regression to the mimalloc team. Until it's addressed, stick with the 2.x series.</p>

    <p>üìä <strong>Raw data:</strong> <a href="https://github.com/1aeo/TorUtils/tree/main/memory/experiments/2026-01-08-5way-allocator-comparison">View experiment data on GitHub</a></p>

    <p style="text-align: center;"><a href="/#get-involved" class="btn">Join the Mission</a></p>

    <div class="footer">
      <p>¬© 2026 1st Amendment Encrypted Openness | Privacy First | No Logs | No Borders</p>
    </div>
  </div>
</body>
</html>

